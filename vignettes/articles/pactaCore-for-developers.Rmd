---
title: "pactaCore for developers"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This article aims software developers. Its goal is to advertise aspects of
pactaCore that may be valuable but not obvious. For learn about installation,
setup, and basic usage see
[README](https://github.com/2DegreesInvesting/pactaCore).

---

```{r}
# Use pactaCore and other optional but convenient packages
library(here)
library(fs)
library(pactaCore)

# Helper
show <- function(path) writeLines(readLines(path))

# Setup a pacta project
pacta <- create_pacta(dir = tempfile("pacta"), data = "~/pacta-data")
dir_tree(pacta, all = TRUE)
```

## Using pactaCore to test and refactor PACTA_analysis

pactaCore can help you test and refactor PACTA_analysis -- specifically web_tool
scripts 1 and 2. Here is how:

* Ensure your ".env" file includes the variable `PACTA_ANALYSIS`, giving the
path to the local copy of PACTA_analysis you want to use as a reference -- e.g.
because its `HEAD` points to the latest commit on `master`.

```{r}
env <- path(pacta, ".env")
lines <- unique(c(readLines(env), "PACTA_ANALYSIS=~/PACTA_analysis"))
writeLines(lines, env)

show(env)
```

* Modify the web tool scripts 1 and 2 in a different local clone of
PACTA_analysis, and create a vector giving the path to the modified scripts.

```{r}
scripts <- path("~/git/PACTA_analysis", paste0("web_tool_script_", 1:2, ".R"))
scripts
```

* Working from pactaCore, run `update_pacta_legacy()`.

```{r}
here::here()

update_pacta_legacy(scripts)
```

* Run `devtools::test()`. If the changes you made to the web tool scripts 
changed the structure of the resulting datasets, then you may already get a
failing test.

```r
devtools::test()
```

* If the previous tests passed, run `compare_full()` to test for more subtle
differences.

```r
compare_full()
```

## Using pactaCore to benefit from its testing infrastructure

Above you saw how to run regression tests against a reference PACTA_analysis
repo. This section covers other more general uses of the testing infrastructure
that pactaCore provides.

* Some tests are slow. You may skip them with `test_fast()` and `check_fast()`.

* Git ignores all files under the directory tests/testthat/_snaps/ to avoid
leaking private data. Re-include public snapshots in .gitignore with a negation
pattern (!), e.g.:

```{r}
lines <- readLines(here(".gitignore"))
writeLines(grep("testthat/_snaps", lines, value = TRUE))
```

* Git ignores the directory tests/testthat/private/. Use it to store regression
references or other private data.

```{r}
dir_tree(here("tests", "testthat", "private"))
```

## Using pactaCore to benefit from error messages

The required setup for pactaCore is enforced with assertions that should help
you figure out what's wrong and how to fix it.

```{r}
# Setup
bad_pacta <- create_pacta(dir = tempfile("bad_pacta"), data = "~/pacta-data")
env <- path(bad_pacta, ".env")
# Degrade .env to show how we handle errors
writeLines(sub("^PACTA_INPUT.*", "", readLines(env)), env)
readLines(env)

try(run_pacta(env))

# Set the environment variable but incorrectly
writeLines("PACTA_INPUT=/bad/path", env)

try(run_pacta(env))
```

## Using pactaCore to access a dockerized computing environment

You can access a dockerized computing environment in four steps:

1. Install `docker`.

2. Install `docker-compose`.

3. Clone pactaCore and make it your working directory.

4. Ensure your ".env" file sets the `PASSWORD` to login to RStudio.

```{r}
show(here(".env"))
```

5. Run `docker-compose up`.

Rstudio is now available from your web browser at localhost:8787. Login with
username "rstudio" and your password.

In the container, the required directories will be mounted under /home/rstudio,
and discovered via the file ".env_rstudio":

```{r}
show(here(".env_rstudio"))
```
